# ğŸ“– My-Books
- My-BooksëŠ” ê³ ê°ì´ ì±…ì„ ê²€ìƒ‰í•˜ê³  ì£¼ë¬¸í•  ìˆ˜ ìˆëŠ” ì¸í„°ë„· ì„œì ì…ë‹ˆë‹¤.
- URL(ë§Œë£Œ): https://www.my-books.store
- Api Docs(ë§Œë£Œ) : https://www.my-books.store/api-docs

- [api-server](https://github.com/My-Books-projects/resource)
- [gateway-server](https://github.com/My-Books-projects/gateway)
- [auth-server](https://github.com/My-Books-projects/authorization)

### êµ¬ì„±ì›
| <a href="https://github.com/minsu11"><img src="https://github.com/minsu11.png" width="100px"><br>ë°•ë¯¼ìˆ˜</a> | <a href="https://github.com/newjaehun"><img src="https://github.com/newjaehun.png" width="100px"><br>ì‹ ì¬í›ˆ</a> | <a href="https://github.com/damho-lee"><img src="https://github.com/damho-lee.png" width="100px"><br>ì´ë‹´í˜¸</a> |<a href="https://github.com/masiljangajji"><img src="https://github.com/masiljangajji.png" width="100px"><br>ì´ìŠ¹ì¬</a> |<a href ="https://github.com/hyeonjaez"> <img src ="https://github.com/hyeonjaez.png" width ="100px"><br>ì •ì¬í˜„</a>
|-----|-----|-----|----|-----|

### ê°œë°œ í™˜ê²½
- ê°œë°œë„êµ¬: Intellij IDEA - Ultimate
- ì–¸ì–´: Java 11 LTS<br>
- ë¹Œë“œë„êµ¬: Maven
- ê°œë°œ
  - Spring Framework: 5.3
  - Spring Boot: 2.7.18
  - Spring Cloud
    - Spring Cloud Gateway
    - Spring Cloud Netflex(Eureka)
    - Spring Cloud Config
  - Spring Data
    - Spring Data JPA
    - Spring Data Elasticsearch
    - Spring Data Redis
  - Spring Batch
  - Spring Rest Docs
  - JPA
    - QueryDSL
- í…ŒìŠ¤íŠ¸
  - Junit5
  - AssertJ
  - Mockito
  - SonarQube
- ë°ì´í„°ë² ì´ìŠ¤
  - MySQL: 8.0.25
  - Redis
- ê²€ìƒ‰ì—”ì§„
  - Elastic Search: 7.11.1
- ERD
  - ERDCloud
- UI
  - BOOTSTRAP5
  - TOAST UI
- NHN Cloud
  - Instance
  - Secure Key Manager
  - Object Storage
  - Load Balancer
- ê¸°íƒ€
  - Dooray Hook Sender

### ì‚¬ìš© ê¸°ìˆ 
![Java](https://img.shields.io/badge/java-%23ED8B00.svg?style=for-the-badge&logo=openjdk&logoColor=white)
![Apache Maven](https://img.shields.io/badge/Apache%20Maven-C71A36?style=for-the-badge&logo=Apache%20Maven&logoColor=white)
![JWT](https://img.shields.io/badge/JWT-black?style=for-the-badge&logo=JSON%20web%20tokens)
<br>
![Bootstrap5](https://img.shields.io/badge/Bootstrap5-7952B3.svg?style=for-the-badge&logo=bootstrap&logoColor=white)
![Thymeleaf](https://img.shields.io/badge/Thymeleaf-005F0F.svg?style=for-the-badge&logo=thymeleaf&logoColor=white)
![JavaScript](https://img.shields.io/badge/JavaScript-F7DF1E.svg?style=for-the-badge&logo=javascript&logoColor=black)
<br>
![Spring](https://img.shields.io/badge/spring-%236DB33F.svg?style=for-the-badge&logo=spring&logoColor=white)
![Spring Boot](https://img.shields.io/badge/Spring_Boot-%236DB33F.svg?style=for-the-badge&logo=spring-boot&logoColor=white)
![Spring Batch](https://img.shields.io/badge/Spring_Batch-%236DB33F.svg?style=for-the-badge&logo=spring&logoColor=white)
![Spring Eureka](https://img.shields.io/badge/Spring_Eureka-6DB33F.svg?style=for-the-badge&logo=spring&logoColor=white)
![Spring Cloud Gateway](https://img.shields.io/badge/Spring_Cloud_Gateway-6DB33F.svg?style=for-the-badge&logo=spring&logoColor=white)
<br>
![MySQL](https://img.shields.io/badge/MySQL-4479A1.svg?style=for-the-badge&logo=mysql&logoColor=white)
![JPA](https://img.shields.io/badge/JPA-007396.svg?style=for-the-badge&logo=java&logoColor=white)
![Hibernate](https://img.shields.io/badge/Hibernate-59666C.svg?style=for-the-badge&logo=hibernate&logoColor=white)
![QueryDSL](https://img.shields.io/badge/QueryDSL-F37626.svg?style=for-the-badge&logo=java&logoColor=white)
![Elasticsearch](https://img.shields.io/badge/Elasticsearch-005571.svg?style=for-the-badge&logo=elasticsearch&logoColor=white)
![Redis](https://img.shields.io/badge/Redis-DC382D.svg?style=for-the-badge&logo=redis&logoColor=white)
<br>
![GitHub Actions](https://img.shields.io/badge/github%20actions-%232671E5.svg?style=for-the-badge&logo=githubactions&logoColor=white)
![Jenkins](https://img.shields.io/badge/jenkins-%232C5263.svg?style=for-the-badge&logo=jenkins&logoColor=white)
![Docker](https://img.shields.io/badge/docker-%230db7ed.svg?style=for-the-badge&logo=docker&logoColor=white)
![Ubuntu](https://img.shields.io/badge/Ubuntu-E95420?style=for-the-badge&logo=ubuntu&logoColor=white)
![Nginx](https://img.shields.io/badge/nginx-%23009639.svg?style=for-the-badge&logo=nginx&logoColor=white)
<br>
![Git](https://img.shields.io/badge/Git-F05032.svg?style=for-the-badge&logo=git&logoColor=white)
![GitHub](https://img.shields.io/badge/GitHub-181717.svg?style=for-the-badge&logo=github&logoColor=white)
![IntelliJ IDEA](https://img.shields.io/badge/IntelliJ_IDEA-000000.svg?style=for-the-badge&logo=intellij-idea&logoColor=white)
![DataGrip](https://img.shields.io/badge/DataGrip-000000.svg?style=for-the-badge&logo=datagrip&logoColor=white)
![SonarLint](https://img.shields.io/badge/SonarLint-CB2029.svg?style=for-the-badge&logo=sonarlint&logoColor=white)
![SonarQube](https://img.shields.io/badge/SonarQube-4E9BCD.svg?style=for-the-badge&logo=sonarqube&logoColor=white)

## ì•„í‚¤í…ì³ êµ¬ì¡°
![322182830-f451aa1e-7312-465c-ab46-01c95a38fe7c](https://github.com/masiljangajji/nhnacademy-be4-My-Books/assets/61807355/dc88b34a-a70b-482d-ab2b-e1ba84165c1d)


## CI/CD
![CI_CD](https://github.com/nhnacademy-be4-My-Books/.github/assets/80580473/5cd4f639-bd75-47cc-8c04-eb0383b8e31f)
### ERD
![er1](https://github.com/nhnacademy-be4-My-Books/.github/assets/80580473/443914c1-c967-4032-a8d2-48e584220bf2)
### WBS
- GitHub Projectsì˜ [RoadMap](https://github.com/orgs/My-Books-projects/projects/2/views/1?groupedBy%5BcolumnId%5D=Assignees) ì‚¬ìš©
  <img width="2552" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-03-27 00 17 31" src="https://github.com/nhnacademy-be4-My-Books/.github/assets/80580473/ad52f456-200d-480b-aa6d-8c3ae032bf4d">

### í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€
- Resource API <br>
![tc2](https://github.com/nhnacademy-be4-My-Books/.github/assets/80580473/26664d9e-0b39-4381-8393-301e9bcf8c4f)
- Authorization API <br>
![td_auth](https://github.com/nhnacademy-be4-My-Books/.github/assets/80580473/0807ebeb-2b10-4153-bbbb-063dfaf1a789)
## ê¸°ëŠ¥


íšŒì›
 - íšŒì›ê°€ì… , ìˆ˜ì • , íƒˆí‡´ ,ì¡°íšŒ
 - íšŒì›ê°€ì… ì‹œ ìœ íš¨ì„± ê²€ì‚¬ ë° ì¤‘ë³µê²€ì‚¬ , dooray message hookì„ ì´ìš©í•œ ì¸ì¦ 
 - íšŒì› ë¹„ë°€ë²ˆí˜¸ëŠ” BCrypt ë¥¼ ì‚¬ìš©í•´ ì•”í˜¸í™” í•˜ì—¬ DBì— ì €ì¥
 - ë¡œê·¸ì•„ì›ƒ , íƒˆí‡´ , ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ , íœ´ë©´ì¸ì¦ , ì ê¸ˆì¸ì¦
    - Logout Interceptor ë™ì‘ , (auth + gateway) redisì— ì¡´ì¬í•˜ëŠ” ë¦¬í”„ë˜ì‹œí† í°ê³¼ ìœ ì € ì•„ì´ë”” ì •ë³´ ì‚­ì œ , Front ì¿ í‚¤ ì‚­ì œ 
  - íšŒì› ë“±ê¸‰ 
    - ë“±ë¡ , ì¡°íšŒ
    - íšŒì› ë“±ê¸‰ì€ ì¶”ê°€ì‹œ ê¸°ì¡´ì˜ ë“±ê¸‰ì„ ìë™ìœ¼ë¡œ ëŒ€ì²´ (ê¸°ì¡´ ë“±ê¸‰ì€ ë¹„í™œì„±ìœ¼ë¡œ ë³€ê²½)
  - íšŒì› ìƒíƒœ 
    - ì¡°íšŒ 
    - í™œì„± , íœ´ë©´ , ì ê¸ˆ , íƒˆí‡´ ì¡´ì¬ 
    - 90ì¼ê°„ ë¡œê·¸ì¸í•˜ì§€ ì•Šì„ ì‹œ í™œì„±ìƒíƒœë¡œ ë³€ê²½ , ê³„ì • íƒˆì·¨ì‹œ ì ê¸ˆìƒíƒœë¡œ ë³€ê²½
    - í™œì„±ìƒíƒœëŠ” Dooray Hook ì„ ì´ìš©í•œ ì¸ì¦ì„ ì´ìš©í•´ í™œì„±ìƒíƒœë¡œ ë³€ê²½ ê°€ëŠ¥ 
    - ì ê¸ˆìƒíƒœëŠ” Dooray Hook ì„ ì´ìš©í•œ ì¸ì¦ ë° ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ìœ¼ë¡œ í™œì„±ìƒíƒœë¡œ ë³€ê²½ ê°€ëŠ¥
   

### ë¡œê·¸ì¸ ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ 
> ì¼ë°˜ íšŒì› ë¡œê·¸ì¸ì„ ì˜ˆì‹œë¡œ ê·¸ë ¸ìŠµë‹ˆë‹¤.
![My-Books-á„…á…©á„€á…³á„‹á…µá†« drawio (9)](https://github.com/My-Books-projects/gateway/assets/61807355/df7b0cde-c7a9-4dfb-8003-ace0bd167783)

- ë¡œê·¸ì¸ ì ˆì°¨ 
    1. Front ì—ì„œ ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ ë¥¼ ì…ë ¥ 
    2. ì´ë©”ì¼ ì¸ì¦ìš”ì²­ì„ ë³´ëƒ„ 
    3. ì´ë©”ì¼ ì¸ì¦ ì„±ê³µì‹œ BCryptë¡œ ì•”í˜¸í™”ëœ ë¹„ë°€ë²ˆí˜¸ë¥¼ Frontë¡œ ì‘ë‹µ 
    4. ì‚¬ìš©ìê°€ ì…ë ¥í•œ í‰ë¬¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ BCryptë¡œ ì•”í˜¸í™”ëœ ë¹„ë°€ë²ˆí˜¸ì™€ ê²€ì¦
    5. ì„±ê³µì‹œ í† í°ë°œê¸‰ ë° ì¿ í‚¤ì— ì¶”ê°€
    6. ë¡œê·¸ì¸ í¬ì¸íŠ¸ ì ë¦½,ë¡œê·¸ì¸ ì‹œê°„ ê°±ì‹ 
  - payco ë¡œê·¸ì¸ ì ˆì°¨ 
    1. í˜ì´ì½” ë¡œê·¸ì¸ api í˜¸ì¶œ 
    2. oauthId ë¡œ ìµœì´ˆ ë¡œê·¸ì¸ íŒë³„
    3. ìµœì´ˆ ë¡œê·¸ì¸ì‹œ
          -  ì‚¬ìš©ìê°€ ì •ë³´ì œê³µ ë™ì˜ë¥¼ í•œ ê²½ìš°
              - í•´ë‹¹ ì •ë³´ë¡œ íšŒì›ê°€ì… ë° ë¡œê·¸ì¸ ì²˜ë¦¬ 
              - ë¹„ë°€ë²ˆí˜¸ëŠ” dummy ë¼ëŠ” ê°’ìœ¼ë¡œ ë“±ë¡ (ë¡œê·¸ì¸ì‹œ BCryptë¡œ ê²€ì¦í•˜ê¸° ë–„ë¬¸ì— dummyë¼ëŠ” í‰ë¬¸ìœ¼ë¡œëŠ” ë¡œê·¸ì¸ ì¸ì¦ ì‹¤íŒ¨)
          -  ì‚¬ìš©ìê°€ ì •ë³´ì œê³µ ë™ì˜ë¥¼ í•˜ì§€ ì•Šì€ ê²½ìš° 
              - ì´ë©”ì¼ , ìƒì¼ ë“±ì˜ ì •ë³´ë¥¼ ì…ë ¥ë°›ëŠ” Form ìœ¼ë¡œ ì´ë™
              - í•´ë‹¹ ì •ë³´ë¡œ íšŒì›ê°€ì… ë° ë¡œê·¸ì¸ ì²˜ë¦¬
    4. ìµœì´ˆ ë¡œê·¸ì¸ì´ ì•„ë‹ ì‹œ 
       - ë¡œê·¸ì¸ì²˜ë¦¬


 ì¸ì¦/ì¸ê°€ 
  - ë¡œê·¸ì¸ 
    1. ë¡œê·¸ì¸ ì„±ê³µì‹œ Auth ì„œë²„ í˜¸ì¶œ 
    2. Auth Server JWT ì—‘ì„¸ìŠ¤í† í°ì„ ë°œê¸‰ , í† í° ë°œê¸‰ì‹œ Redisì— (UUID+ipì£¼ì†Œ+X-User-Agent , ìœ ì € ì•„ì´ë””) í˜•ì‹ìœ¼ë¡œ ì €ì¥ , í† í°ì—ëŠ” UUIDê°€ ê¸°ì…
    3. Auth Server Redis ì— (ì—‘ì„¸ìŠ¤ í† í°+ipì£¼ì†Œ+X-User-Agent,í‚¤ë©”ë‹ˆì €ê°€ ê´€ë¦¬í•˜ëŠ” ì•”í˜¸ê°’ê³¼ ipì£¼ì†Œë¥¼ BCryptë¡œ ì ê·¼ ê°’) í˜•ì‹ìœ¼ë¡œ ì €ì¥ , RefreshTokenì˜ ì—­í• ì„ í•¨ 
    
       ~~~
       
         /**
        * methodName : createToken
        * author : masiljangajji
        * description : ë¡œê·¸ì¸ì‹œ JWT ì—‘ì„¸ìŠ¤ í† í°ê³¼ Refresh Token ì„ ë°œí–‰í•¨
        * TokenRequest ì— ìœ ì €ì˜ ì •ë³´ ë¿ ì•„ë‹ˆë¼ ip , X-User-Agent ì˜ ë¶€ê°€ì •ë³´ë„ í¬í•¨
        * í† í°ì— ìœ ì € ì•„ì´ë””ë¥¼ ê¸°ì…í•˜ì§€ ì•Šê¸° ìœ„í•´ì„œ í˜ì´ë¡œë“œì— UUID ë¥¼ ë„£ê³  , ê·¸ì— ë§¤ì¹­ë˜ëŠ” userId ì •ë³´ë¥¼ ë ˆë””ìŠ¤ì— ì‚½ì…í•¨
        * ì´ ê°’ì€ gateway ì—ì„œ UUID + ip + X-User-Agent ë¥¼ ì´ìš©í•´ userId ë¥¼ ê°€ì ¸ì˜¬ ê²ƒì„
        * ë¦¬í”„ë˜ì‹œ í† í°ì€ JWT ì˜ í˜•íƒœëŠ” ì•„ë‹ˆê³  , í‚¤ë©”ë‹ˆì €ì—ì„œ ê´€ë¦¬í•˜ëŠ” ì•”í˜¸ê°’ + ip ë¥¼ ë¹„í¬ë¦½íŠ¸ë¡œ ê°ì‹¼ ê°’
        * ë§Œì•½ ë ˆë””ìŠ¤ê°€ íƒˆì·¨ë‹¹í•œë‹¤ í•´ë„ ë¹„í¬ë¦½íŠ¸ë¡œ ê°ì‹¸ì ¸ìˆê¸° ë–„ë¬¸ì— ì›ë¬¸ì„ ì•Œ ìˆ˜ ì—†ê³  , í‚¤ë©”ë‹ˆì €ê°€ ê´€ë¦¬í•˜ëŠ” ì•”í˜¸ê°’ì„ ëª¨ë¥´ê¸° ë–„ë¬¸ì— ì¡°ì‘ì´ ë¶ˆê°€ëŠ¥í•¨
        * ë¦¬í”„ë˜ì‹œí† í°ì€ Access Token + ip + X-User-Agent ì •ë³´ë¥¼ ì´ìš©í•´ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ
        *
        * @param tokenRequest request
        * @return response entity
        */
        public ResponseEntity<TokenResponse> createToken(
            @RequestBody TokenRequest tokenRequest) {


        String ipAddress = tokenRequest.getIp();
        String userAgent = tokenRequest.getUserAgent();

        redisService.setValues(tokenRequest.getUuid() + ipAddress + userAgent,
                String.valueOf(tokenRequest.getUserId()),
                Duration.ofMillis(jwtConfig.getRefreshExpiration()));

        String accessToken = authService.createAccessToken(tokenRequest);

        redisService.setValues(accessToken + ipAddress + userAgent,
                passwordEncoder.encode(keyConfig.keyStore(redisConfig.getRedisValue()) + ipAddress),
                Duration.ofMillis(jwtConfig.getRefreshExpiration()));

        return new ResponseEntity<>(new TokenResponse(accessToken), HttpStatus.CREATED);
        }
        ~~~

    4. ì—‘ì„¸ìŠ¤í† í°ì„ ì‘ë‹µìœ¼ë¡œ Frontë¡œ ë°˜í™˜

  - ë¡œê·¸ì•„ì›ƒ

    Front Server Logout Interceptor ë™ì‘ 
    ~~~
        
        
        @Override
        public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler,
                            ModelAndView modelAndView) {

            ApplicationContext context = WebApplicationContextUtils.getWebApplicationContext(request.getServletContext());
            TokenAdaptor tokenAdaptor = Objects.requireNonNull(context).getBean(TokenAdaptor.class);

            //ë¦¬í”„ë˜ì‹œí† í° ìœ ì €ì•„ì´ë”” redis ì‚­ì œ
            tokenAdaptor.deleteRefreshToken(
                    new LogoutRequest((String) request.getAttribute("identity_cookie_value"), Utils.getUserIp(request),
                            Utils.getUserAgent(request)));
            // ì—‘ì„¸ìŠ¤ í† í° ë‹´ì€ ì¿ í‚¤ ì‚­ì œ
            CookieUtils.deleteJwtCookie(response);


            // UUID - UserId ë‹´ì€ redis ì‚­ì œ ë° admin ì¿ í‚¤ ì‚­ì œ
            if (Objects.nonNull(request.getAttribute("admin_cookie_value"))) {
                log.debug("ì–´ë“œë¯¼ì¿ í‚¤ ì‚­ì œ ì‹œì‘ ");
                RedisAuthService redisAuthService = context.getBean(RedisAuthService.class);
                redisAuthService.deleteValues((String) request.getAttribute("admin_cookie_value"));
                log.debug("ë ˆë””ìŠ¤ ì‚­ì œ");
                CookieUtils.deleteAdminCookie(response);
                log.debug("ì–´ë“œë¯¼ì¿ í‚¤ ì‚­ì œ ì™„ë£Œ");
            }


        }
        
    ~~~
    Auth Server ë¡œê·¸ì•„ì›ƒ ìš”ì²­
    ~~~

         /**
        * methodName : deleteRefreshToken
        * author : masiljangajji
        * description : ë¡œê·¸ì•„ì›ƒ ìš”ì²­ì´ ì˜¬ ì‹œ ë ˆë””ìŠ¤ì—ì„œ ìœ ì €ì•„ì´ë””ì™€ ë¦¬í”„ë˜ì‹œ í† í°ì˜ ì •ë³´ë¥¼ ì‚­ì œí•¨
        * ê¸°ì¡´ì˜ ì—‘ì„¸ìŠ¤ í† í°ì€ ìœ íš¨í•˜ì§€ë§Œ ë¡œê·¸ì•„ì›ƒì‹œ ìœ ì €ì•„ì´ë””ë¥¼ ë‹´ê³ ìˆëŠ” ì •ë³´ê°€ ì‚¬ë¼ì§€ê¸° ë–„ë¬¸ì—
        * gateway ì—ì„œ ê²€ì¦ì‹œ UUID ì— í•´ë‹¹í•˜ëŠ” ìœ ì €ì•„ì´ë”” ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í•´ InValid í•˜ë‹¤ëŠ” íŒë‹¨ì„ í•˜ê²Œ ë¨
        * ë”°ë¼ì„œ ë¡œê·¸ì•„ì›ƒì‹œ ê¸°ì¡´ì˜ ì—‘ì„¸ìŠ¤í† í°ì€ ë¬´ë ¥í™”ë˜ëŠ” íš¨ê³¼ë¥¼ ê°–ê²Œ ë¨
        *
        * @param logoutRequest request
        * @return response entity
        */

        @DeleteMapping("/logout")
        public ResponseEntity<Void> deleteRefreshToken(@RequestBody LogoutRequest logoutRequest) {
            DecodedJWT jwt = JWT.decode(logoutRequest.getAccessToken());

            String ipAddress = logoutRequest.getIp();
            String userAgent = logoutRequest.getUserAgent();
            redisService.deleteValues(logoutRequest.getAccessToken() + ipAddress + userAgent);
            redisService.deleteValues(jwt.getSubject() + ipAddress + userAgent);
            return new ResponseEntity<>(HttpStatus.NO_CONTENT);
        }
    ~~~

    ### ì¸ê°€ì²˜ë¦¬ ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ 
    > ë¡œê·¸ì¸ í›„ ë™ì‘ ê°€ëŠ¥í•œ ë§ˆì´í˜ì´ì§€ ì¡°íšŒ (/user) ë¥¼ ì˜ˆì‹œë¡œ ê·¸ë ¸ìŠµë‹ˆë‹¤.
    ![My-Books-á„‹á…µá†«á„€á…¡ drawio (1)](https://github.com/My-Books-projects/gateway/assets/61807355/56b6586d-6dde-4898-ac4f-80d9b556c224)

    1. Front Serverì—ì„œ Cookie Interceptor ë¥¼ ì´ìš©í•´ ì¿ í‚¤ ì •ë³´ í™•ì¸
    2. RequiredAuthorization ì–´ë…¸í…Œì´ì…˜ì´ ìˆëŠ” ê²½ìš° Authorization AOP ë™ì‘
    3. í† í° ì •ë³´ë¥¼ í—¤ë”ì— ë‹´ì•„ gateway ë¡œ ìš”ì²­ 
    4. Gateway Server ëŠ” ì¸ì¦/ì¸ê°€ê°€ í•„ìš”í•œ ê²½ìš°ì™€ ê·¸ë ‡ì§€ ì•Šì€ ê²½ìš°ë¥¼ ë‚˜ëˆ ì„œ ì²˜ë¦¬ 
        ~~~
          
            @Bean
          public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
              return builder.routes()
                      .route("auth", r -> r.path("/auth/**") // ì „ë¶€ í—ˆìš© í•  ê²ƒ , í† í°ë°œê¸‰ìš”ì²­
                              .uri(urlProperties.getAuth()))
                      .route("api_user", p -> p.path("/api/member/**") // ìœ ì € ê¶Œí•œì´ í•„ìš” í•œ ê²½ìš°
                              .filters(f -> f.filter(new AuthFilter(redisService).apply(new AuthFilter.Config())))
                              .uri(RESOURCE)
                      )
                      .route("api_admin", p -> p.path("/api/admin/**") // ì–´ë“œë¯¼ ê¶Œí•œì´ í•„ìš” í•œ ê²½ìš°
                              .filters(f -> f.filter(new AuthFilter(redisService).apply(new AuthFilter.Config())))
                              .uri(RESOURCE)
                      )
                      .route("api_all", p -> p.path("/api/**") // ê¶Œí•œì´ í•„ìš” ì—†ëŠ” ê²½ìš°
                              .uri(RESOURCE)
                      )
                      .build();
              }
                
        ~~~

      5. Gateway Server ì—ì„œ í† í° ê²€ì¦ (í† í°ì¡°ì‘,ë§Œë£Œ,ìœ ì €ê¶Œí•œ,ìœ ì €ìƒíƒœ)

      6. Gateway Server ê²€ì¦ ì„±ê³µì‹œ url ë³€ê²½ ë° Redisì—ì„œ ìœ ì € ì•„ì´ë””ë¥¼ ì°¾ì•„ í—¤ë”ì— ë„£ì–´ ìš”ì²­ì§„í–‰
         
         ~~~
                public static ServerHttpRequest getAdminRequest(ServerWebExchange exchange, String originalPath) {

                return exchange.getRequest().mutate()
                        .path(originalPath.replace("/api/admin/", "/api/")) // ìƒˆë¡œìš´ URL ê²½ë¡œ ì„¤ì •
                        .build();
            }

            public static ServerHttpRequest getUserRequest(ServerWebExchange exchange, String originalPath, String key,
                                                        RedisService redisService) {

                return exchange.getRequest().mutate()
                        .path(originalPath.replace("/api/member/", "/api/")) // ìƒˆë¡œìš´ URL ê²½ë¡œ ì„¤ì •
                        .header("X-User-Id", redisService.getValues(key)) // ìœ ì € ì •ë³´ ë³´ë‚´ê¸°
                        .build();
            }
         ~~~

      7. Gateway Server ê²€ì¦ ì‹¤íŒ¨ì‹œ ì—ëŸ¬ ì²˜ë¦¬ 

          ~~~
          return ErrorResponseHandler.handleInvalidToken(exchange, HttpStatus.FORBIDDEN,
                          ErrorMessage.STATUS_IS_DORMANT_EXCEPTION.getMessage()); //  í† í°ì€ ìœ íš¨í•œë° íœ´ë©´ ìƒíƒœì„
              } catch (StatusIsLockException e) {
                  return ErrorResponseHandler.handleInvalidToken(exchange, HttpStatus.FORBIDDEN,
                          ErrorMessage.STATUS_IS_LOCK_EXCEPTION.getMessage()); //  í† í°ì€ ìœ íš¨í•œë° ì ê¸ˆ ìƒíƒœì„
              } catch (ForbiddenAccessException e) {
                  return ErrorResponseHandler.handleInvalidToken(exchange, HttpStatus.FORBIDDEN,
                          ErrorMessage.INVALID_ACCESS.getMessage()); //  í† í°ì€ ìœ íš¨í•œë° ê¶Œí•œ ì—†ìŒ 403
              } catch (TokenExpiredException e) {
                  return ErrorResponseHandler.handleInvalidToken(exchange, HttpStatus.UNAUTHORIZED,
                          ErrorMessage.TOKEN_EXPIRED.getMessage()); // í† í° ë§Œë£ŒëìŒ ì¸ì¦ í•„ìš” 401
              } catch (JWTVerificationException e) {
                  return ErrorResponseHandler.handleInvalidToken(exchange, HttpStatus.UNAUTHORIZED,
                          ErrorMessage.INVALID_TOKEN.getMessage()); // í† í°ì´ ì¡°ì‘ëìŒ ì˜¬ë°”ë¥´ì§€ ì•Šì€ ìš”ì²­ 401
          ~~~

      
      8. Front Server Authorization AOP ì—ì„œ ì—ëŸ¬ì— ë”°ë¥¸ ì‘ë‹µì„ ì„ íƒ 
        
            ~~~
                @Around(value = "@annotation(store.mybooks.front.auth.Annotation.RequiredAuthorization)")
            public Object aroundMethod(ProceedingJoinPoint joinPoint) throws Throwable {

                HttpServletRequest request = ((ServletRequestAttributes) Objects.requireNonNull(
                        RequestContextHolder.getRequestAttributes())).getRequest();

                HttpServletResponse response =
                        ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getResponse();

                RequestContextHolder.setRequestAttributes(new ServletRequestAttributes(request));
                RequestContextHolder.currentRequestAttributes()
                        .setAttribute("authHeader", Utils.addAuthHeader(request), RequestAttributes.SCOPE_REQUEST);

                try {
                    return joinPoint.proceed();
                } catch (RuntimeException e) {

                    String error = e.getMessage();
                    log.error("aop fin:" + error);

                    if (error.contains(ErrorMessage.INVALID_ACCESS.getMessage())) { // ê¶Œí•œì´ ì—†ìŒ
                        throw new AccessIdForbiddenException(); // ì¸ë±ìŠ¤ë¡œ ë³´ë‚´ê¸°
                    } else if (error.contains(ErrorMessage.TOKEN_EXPIRED.getMessage())) { // í† í°ë§Œë£Œ ì¬ë°œê¸‰ ë°›ê³  ë‹¤ì‹œ ë¶€ë¥´ê¸°

                        // í† í°ì„ ê°±ì‹ í•˜ëŠ” ìš”ì²­ì„ ë³´ëƒ„ (ê¸°ì¡´ ì—‘ì„¸ìŠ¤ í† í°ì„ ë³´ëƒ„)
                        RefreshTokenResponse refreshTokenResponse =
                                tokenAdaptor.refreshAccessToken(
                                        new RefreshTokenRequest((String) request.getAttribute("identity_cookie_value"),
                                                Utils.getUserIp(request), Utils.getUserAgent(request)));

                        // ë¦¬í”„ë˜ì‹œ í† í° ë§Œë£Œ ëê±°ë‚˜ ìœ íš¨í•˜ì§€ì•ŠìŒ
                        if (Objects.isNull(refreshTokenResponse.getAccessToken())) {
                            throw new TokenExpiredException();
                        }

                        // ì¿ í‚¤ì— ì¬ë°œê¸‰í•œ ì—‘ì„¸ìŠ¤í† í° ë„£ì–´ì£¼ê³ 
                        CookieUtils.addJwtCookie(Objects.requireNonNull(response), refreshTokenResponse.getAccessToken());
                        // í—¤ë” ì„¤ì •í•´ì£¼ê³  ê¸°ì¡´ ë©”ì„œë“œ ë‹¤ì‹œ ë¶ˆëŸ¬
                        RequestContextHolder.currentRequestAttributes()
                                .setAttribute("authHeader", Utils.refreshAuthHeader(refreshTokenResponse.getAccessToken()),
                                        RequestAttributes.SCOPE_REQUEST);
                        // ì–´ë“œë¯¼ ì¿ í‚¤ë¥¼ ì²´í¬í•˜ëŠ” redis ë§Œë£Œì‹œê°„ ì¬ì„¤ì •
                        String adminCookieValue = (String) request.getAttribute("admin_cookie_value");
                        if (Objects.nonNull(adminCookieValue)) {
                            redisAuthService.expireValues(adminCookieValue, redisProperties.getAdminExpiration());
                            // ì¿ í‚¤ ë§Œë£Œì‹œê°„ ì¬ì„¤ì •
                            CookieUtils.addAdminCookie(response, adminCookieValue);
                        }
                        return joinPoint.proceed();
                    } else if (error.contains(ErrorMessage.INVALID_TOKEN.getMessage())) { // í† í°ìœ„ì¡°ë¨ ì¿ í‚¤ì‚­ì œ
                        throw new AuthenticationIsNotValidException();
                    } else if (error.contains(ErrorMessage.STATUS_IS_DORMANT_EXCEPTION.getMessage())) { // íœ´ë©´ìƒíƒœ -> íœ´ë©´ì¸ì¦ì‚¬ì´íŠ¸ë¡œ
                        throw new StatusIsDormancyException();
                    } else if (error.contains(ErrorMessage.STATUS_IS_LOCK_EXCEPTION.getMessage())) { // ì ê¸ˆìƒíƒœ -> ì ê¸ˆì¸ì¦ í˜ì´ì§€ë¡œ
                        throw new StatusIsLockException();
                    }

                    throw e; // ë‹¤ë¥¸ ì—ëŸ¬ì¸ ê²½ìš° = í† í°ê´€ë ¨ ì—ëŸ¬ê°€ ì•„ë‹Œê²½ìš° ê·¸ëŒ€ë¡œ Exception ë˜ì§„ë‹¤
                }

            }

            ~~~

    9. Front Server Authorization AOP ì—ì„œ Exception ë°œìƒì‹œ ControllerAdvice ê°€ ì¡ì•„ ë¶„ê¸°ì²˜ë¦¬ 

          ~~~
        // í† í° ì¸ì¦/ì¸ê°€ì™€ ê´€ë ¨ëœ ëª¨ë“  ì˜ˆì™¸ë¥¼ ì¡ìŒ
          @ExceptionHandler({AuthenticationIsNotValidException.class, AccessIdForbiddenException.class,
                  StatusIsDormancyException.class, TokenExpiredException.class, StatusIsLockException.class})
          public String handleAuthException(RuntimeException ex, HttpServletResponse response) {

              if (ex instanceof AuthenticationIsNotValidException | ex instanceof TokenExpiredException) {
                  CookieUtils.deleteJwtCookie(Objects.requireNonNull(response)); // ì¿ í‚¤ ì‚­ì œ
                  CookieUtils.deleteAdminCookie(response);
                  return "redirect:/login"; // í† í°ì¡°ì‘ ëê±°ë‚˜ , ë§Œë£ŒëìŒ -> ë‹¤ì‹œ ë¡œê·¸ì¸
              } else if (ex instanceof StatusIsDormancyException) {
                  return "redirect:/verification/dormancy";  // ìœ ì €ê³„ì • íœ´ë©´ìƒíƒœ
              } else if (ex instanceof StatusIsLockException) {
                  return "redirect:/verification/lock"; // ìœ ì •ê³„ì • ì ê¸ˆìƒíƒœ
              }

              // ê¶Œí•œì—†ëŠ” ê²½ìš° index
              return "redirect:/";
          }

        ~~~
 

í† í° 
  - Access Token(30ë¶„) , Refresh Token(1ì‹œê°„)
    -  ì›¹ í™˜ê²½ì—ì„œì˜ ì„œë¹„ìŠ¤ë¥¼ ê¸°ë³¸ìœ¼ë¡œ í•˜ê³ ìˆê¸° ë–„ë¬¸ì— ê³µìš© PCë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ê°€ ë°œìƒ ê°€ëŠ¥<br>
       Refresh Tokenì˜ ë§Œë£Œê¸°ê°„ì´ ê¸¸ ê²½ìš° ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì‚¬ì´íŠ¸ë¥¼ ë°©ë¬¸ì‹œ í† í°ì´ ê°±ì‹ ë˜ë©° ë¡œê·¸ì¸ì´ ê³„ì†í•´ì„œ ìœ ì§€ë¨<br>
       ë§Œì•½ ëª¨ë°”ì¼ í™˜ê²½ì´ë¼ë©´ ê³µìš©ìœ¼ë¡œ í•¸ë“œí°ì„ ì‚¬ìš©í•  ì¼ì€ ì—†ê¸° ë–„ë¬¸ì— 1ì£¼ì¼ ì´ìƒì˜ ê¸´ ë§Œë£Œì‹œê°„ì„ ì„¤ì •í•´ë„ ê´œì°®ë‹¤ê³  ìƒê°í•¨


 ì£¼ì†Œ
  - ì£¼ì†Œ ë“±ë¡ , ìˆ˜ì • , ì‚­ì œ , ì¡°íšŒ
  - Daum ì£¼ì†Œ api ë¥¼ ì´ìš©í•´ ìš°í¸ë²ˆí˜¸ , ë„ë¡œëª… ì£¼ì†Œ ì¡°íšŒ 
  - ìµœëŒ€ 10ê°œê¹Œì§€ì˜ ì£¼ì†Œ ì €ì¥

ë¦¬ë·°(ìƒí’ˆí‰)
 - ë¦¬ë·° ë“±ë¡, ìˆ˜ì •, ì¡°íšŒ
 - ë³„ì  ë¶€ì—¬ ê°€ëŠ¥ (1 ~ 5)
 - êµ¬ë§¤ì¸ë§Œ ë¦¬ë·° ì‘ì„± ê°€ëŠ¥
 - ë¦¬ë·°ëŠ” êµ¬ë§¤í•œ ë„ì„œë‹¹ 1íšŒë§Œ ì‘ì„± ê°€ëŠ¥
 - ë¦¬ë·° ì‘ì„±ì‹œ í¬ì¸íŠ¸ ì ë¦½ 
   - ì´ë¯¸ì§€ê°€ ìˆëŠ” ë¦¬ë·°ì™€ ì—†ëŠ” ë¦¬ë·°ë¥¼ êµ¬ë¶„í•´ ì°¨ë“±ì§€ê¸‰  
 - ì±… ì¡°íšŒì‹œ ì „ì²´ ë¦¬ë·° ê°œìˆ˜ì™€ í‰ì ì˜ í‰ê· ì„ í•¨ê»˜ ë³´ì—¬ì¤Œ


ë¡œê·¸ì¸ ì‹œì—° 
![login](https://github.com/masiljangajji/jankens/assets/61807355/4ecd3dc0-2fa0-4548-86df-62b160f1ae65)

ë§ˆì´í˜ì´ì§€ ì‹œì—°
![mypage](https://github.com/masiljangajji/jankens/assets/61807355/85a57196-5b5a-4c15-8b11-e0521beb975b)

ê¸°ëŠ¥ ì‹œì—°

![my-books á„€á…µá„‚á…³á†¼](https://github.com/masiljangajji/nhnacademy-be4-My-Books/assets/61807355/8c938266-1d51-45cc-822c-4168f811f466)

Api Docs
![ApiDocs](https://github.com/masiljangajji/jankens/assets/61807355/d496915d-474e-428b-8671-04019350b6da)

---
